<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>กับดักหัวใจของนายตัวแสบ | โค้ดรัก</title>
  <link href="https://fonts.googleapis.com/css2?family=Mitr&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(145deg, #fdf5ff, #f0f8ff);
      font-family: 'Mitr', sans-serif;
      color: #432d5d;
      padding: 40px;
      max-width: 1024px;
      margin: auto;
      text-align: center;
      user-select: none;
    }
    .content-wrapper {
      text-align: left;
      margin: 0 auto;
      max-width: 900px;
    }

    /* === Header Controls === */
    .header-controls { /* ใหม่: สำหรับรวม site-button, coin, language */
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap; /* เพื่อให้ห่อข้อความลงบรรทัดใหม่ในหน้าจอเล็ก */
      gap: 15px; /* เพิ่มช่องว่างระหว่างรายการ */
    }

    .site-button {
      display: inline-block;
      padding: 12px 28px;
      background-color: #f6d8ff;
      color: #6d3fb0;
      text-align: center;
      font-size: 1.35rem; /* ขนาดเท่าหน้านามปากกา */
      font-weight: bold;
      border-radius: 999px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      text-decoration: none;
      transition: transform 0.3s ease, background-color 0.3s ease;
      flex-shrink: 0;
    }

    .site-button:hover {
      background-color: #e8c2ff;
      transform: scale(1.05);
    }

    .user-info { /* ใหม่: สำหรับรวม coin และ language */
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: flex-end; /* จัดให้ชิดขวา */
    }

    .coin-display {
      font-size: 0.99rem;
      color: #6e3cab;
    }

    .language-selector {
      font-size: 0.99rem;
      color: #6e3cab;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .language-selector select {
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 6px;
      margin-left: 5px;
    }
    /* === End Header Controls === */
    
    h1 {
      color: #7b4ca0;
      text-align: left;
      font-size: 1.45rem;
      margin-bottom: 10px;
    }

    /* === Cover and Summary Section === */
    .cover-summary-section { /* ปรับปรุง: ใช้ flexbox จัดวางปกและข้อมูล */
      display: flex;
      align-items: center; /* จัดให้อยู่กึ่งกลางในแนวตั้ง */
      justify-content: center; /* จัดกึ่งกลางในแนวนอน */
      gap: 30px; /* ช่องว่างระหว่างปกกับข้อมูล */
      margin-bottom: 30px;
      text-align: left; /* ข้อความภายใน novel-info จะชิดซ้าย */
      max-width: 900px; /* จำกัดความกว้างเหมือน content-wrapper */
      margin-left: auto; /* จัดกึ่งกลาง */
      margin-right: auto; /* จัดกึ่งกลาง */
      padding: 20px; /* เพิ่ม padding */
      background: #ffffff; /* พื้นหลังเพื่อให้กล่องดูเป็นระเบียบ */
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.03);
    }

    .novel-cover {
      width: 180px;
      height: auto; /* ให้ความสูงปรับตามอัตราส่วน */
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      flex-shrink: 0; /* ป้องกันการหดตัวของปก */
    }

    .novel-info {
      flex: 1; /* ให้ส่วนข้อมูลขยายเต็มพื้นที่ที่เหลือ */
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0; /* สำคัญสำหรับ flex item ที่มีข้อความยาวๆ */
    }

    .novel-title {
      font-size: 1.45rem;
      color: #6e3cab;
      margin-bottom: 10px;
      line-height: 1.3;
      text-align: left; /* ชื่อเรื่องชิดซ้าย */
    }

    .summary { /* .novel-summary ถูกเปลี่ยนเป็น .summary */
      white-space: pre-wrap; /* รักษาการขึ้นบรรทัดใหม่ */
      text-indent: 2.5em; /* เยื้องบรรทัดแรก */
      margin-bottom: 0; /* ไม่มี margin-bottom เพิ่มเติม */
      line-height: 1.7;
      color: #5e437f;
      font-size: 1.25rem; /* ขนาดฟอนต์ตามหน้านิยาย */
      text-align: justify;
      background: none; /* ลบพื้นหลังและ shadow ที่ซ้ำซ้อน */
      padding: 0; /* ลบ padding ที่ซ้ำซ้อน */
      box-shadow: none; /* ลบ box-shadow ที่ซ้ำซ้อน */
      border-radius: 0; /* ลบ border-radius ที่ซ้ำซ้อน */
    }
    .summary p { /* เพื่อให้การย่อหน้าทำงานถูกต้อง */
        text-indent: 2.5em;
        margin-bottom: 1em;
    }
    /* === End Cover and Summary Section === */

    .action-section {
      display: flex;
      justify-content: center;
      align-items: stretch;
      flex-wrap: wrap;
      gap: 20px;
      margin: 50px 0;
      text-align: center;
    }

    .action-box {
      flex: 1 1 300px;
      max-width: 400px;
    }
        
    .action-box p {
      font-size: 1.61rem;
      color: #6e3cab;
      margin-bottom: 10px;
    }
        
    .episode {
      margin-bottom: 30px;
    }

    .episode-title {
      cursor: pointer;
      color: #6e3cab;
      font-weight: bold;
      font-size: 1.45rem;
      background-color: #f6e7ff;
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      transition: background 0.3s ease;
      text-align: left;
    }

    .episode-title:hover {
      background-color: #e4ccff;
    }
        
    .unlock-button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #b68df5, #925fdd);
      color: #fff;
      border: none;
      border-radius: 30px;
      font-weight: bold;
      font-size: 0.85rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.3s ease, background 0.3s ease;
    }

    .unlock-button:hover {
      background: linear-gradient(135deg, #925fdd, #b68df5);
      transform: scale(1.05);
    }

    .thank-you {
      text-align: center;
      font-size: 1.25rem;
      margin-top: 60px;
      margin-bottom: 10px;
      color: #5e407f;
      font-style: italic;
    }

    .comment-box {
      margin-top: 40px;
      background: #f5f0ff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .comment-box textarea {
      width: 100%;
      font-family: 'Mitr', sans-serif;
      font-size: 1.25rem;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      resize: vertical;
    }

    .emoji-bar {
      margin-top: 10px;
    }

    .emoji-bar span {
      cursor: pointer;
      font-size: 1.25rem;
      margin-right: 10px;
      transition: transform 0.2s ease;
    }

    .emoji-bar span:hover {
      transform: scale(1.3);
    }

    .submit-button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #a87ce6;
      color: #fff;
      border: none;
      border-radius: 30px;
      font-size: 1.25rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .submit-button:hover {
      background-color: #8f63d2;
    }

    .back-button {
      display: inline-block;
      padding: 12px 28px; /* ขนาด padding */
      background: linear-gradient(135deg, #c79df4, #a57be7);
      color: #fff;
      text-decoration: none;
      border-radius: 30px;
      font-weight: bold;
      font-size: 1.35rem; /* ขนาด font-size */
      box-shadow: 0 4px 12px rgba(167, 125, 221, 0.4);
      transition: all 0.3s ease;
      margin-top: 30px;
    }

    .back-button:hover {
      background: linear-gradient(135deg, #a577e7, #c79df4);
      box-shadow: 0 6px 16px rgba(135, 95, 190, 0.5);
      transform: scale(1.05);
    }

    .back-container {
      text-align: center;
    }

    .footer {
      margin-top: 60px;
      font-size: 1.25rem; /* ปรับขนาด font-size */
      color: #9a7fb5;
      text-align: center;
    }

    .watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 15rem;
      color: rgba(200, 180, 255, 0.12);
      pointer-events: none;
      z-index: 0;
      white-space: nowrap;
    }

    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .text-content { /* .summary ถูกรวมเข้ากับ .text-content ใน CSS */
      white-space: pre-wrap;
      text-align: justify;
      font-size: 1rem;
      line-height: 1.7;
      color: #5e437f;
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.03);
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
    }

    .summary p, .text-content p {
      text-indent: 2.5em;
      margin-bottom: 1em;
    }

    /* Media query สำหรับหน้าจอขนาดเล็ก */
    @media screen and (max-width: 600px) {
      .header-controls {
        flex-direction: column;
        align-items: flex-start;
      }
      .user-info {
        width: 100%;
        justify-content: flex-start;
      }
      .site-button {
        width: 100%;
        box-sizing: border-box;
      }
      .cover-summary-section {
        flex-direction: column;
        text-align: center;
        padding: 15px; /* ลด padding บนมือถือ */
      }
      .novel-title {
        text-align: center; /* จัดกึ่งกลางชื่อเรื่องบนมือถือ */
        margin-top: 20px; /* เพิ่มระยะห่างระหว่างปกกับชื่อเรื่องบนมือถือ */
      }
      .summary {
          font-size: 1rem; /* ปรับขนาดเรื่องย่อบนมือถือ */
      }
      .back-button {
        width: 100%;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
  <div class="header-controls">
    <a href="/" class="site-button" data-i18n="siteButton">✨ Arn-niyay-khan ✨</a>
    <div class="user-info">
      <div class="coin-display" data-i18n="coinLabel">
        💰 เหรียญของคุณ: <span id="coin-count">0</span> เหรียญ
      </div>
      <div class="language-selector">
        <label for="language-select" data-i18n="languageLabel">🌐 เปลี่ยนภาษา:</label>
        <select id="language-select" onchange="switchLang(this.value)">
          <option value="th">ไทย</option>
          <option value="en">English</option>
          <option value="ch">中国人</option>
          <option value="ru">русский язык</option>
          <option value="jp">日本語</option>
          <option value="kr">한국어</option>
          <option value="vn">Tiếng Việt</option>
        </select>
      </div>
    </div>
  </div>
  
  <button onclick="localStorage.clear(); alert('เคลียร์ localStorage แล้วค่ะ'); location.reload();" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; background: red; color: white; padding: 10px; border-radius: 8px;">🧹 ล้าง localStorage</button>
  
  <div class="cover-summary-section">
    <img src="link-to-your-cover.jpg" alt="หน้าปกนิยาย" class="novel-cover">
    <div class="novel-info">
      <h2 class="novel-title" data-i18n="novelTitle">📘 กับดักหัวใจของนายตัวแสบ</h2>
      <div class="summary" id="summary" data-i18n-content-type="summary"
        data-content-th="เมื่อนักเรียนตัวแสบจ้องจะป่วนครูหน้าใหม่หัวใจอ่อนไหว

ความรักในรั้วโรงเรียนจึงไม่ได้หวานอย่างเดียว..."
        data-content-en="When a mischievous student sets his sights on teasing a soft-hearted new teacher,

Love in the school corridors isn’t all sweet and innocent..."
        data-content-ch="当一个调皮的学生盯上了心软的新老师，

校园里的爱情就不再只是甜蜜而已……"
        data-content-ru="Когда озорной ученик решает досаждать добросердечному новому учителю,

Любовь в школьных коридорах становится далеко не такой уж невинной…"
        data-content-jp="いたずら好きな生徒が、心優しい新任教師をからかおうとしたとき、

学園内の恋は、甘いだけでは終わらない…"
        data-content-kr="장난꾸러기 학생이 마음이 여린 신입 교사를 괴롭히기로 결심했을 때,

학교 안의 사랑은 더 이상 달콤하기만 한 것이 아니다…"
        data-content-vn="Khi một học sinh tinh nghịch nhằm vào thầy giáo mới với trái tim yếu mềm,

Tình yêu trong hành lang trường học không chỉ ngọt ngào đơn thuần nữa..." 
      ></div>
    </div>
  </div>

<div class="action-section">
  <div class="action-box">
    <p data-i18n="unlockAll">🔓 ปลดล็อกทุกตอนในครั้งเดียว</p>
    <button class="unlock-button" onclick="confirmPurchaseAll('unlockAll')" data-i18n="unlockButton">ปลดล็อกทุกตอน (4 เหรียญ)</button>
  </div>
  <div class="action-box">
    <p data-i18n="buyPdfButton">📘 ซื้อ PDF + ตอนพิเศษสุดฟินมากกว่า 1 ตอน</p>
    <button class="unlock-button" onclick="confirmPurchaseAll('buyPdf')" data-i18n="buyPdfButton">ซื้อ PDF ทั้งเรื่องและตอนพิเศษมากกว่า 1 ตอน (12 เหรียญ)</button>
  </div>
</div>
  
  <div class="episode">
  <div class="episode-title" onclick="toggleEpisode('ep1')">📖 ตอนที่ 1: พบกันที่โรงเรียน</div>
  <div class="text-content" id="ep1" style="display: none;"
  data-content-th="
นายจะมานั่งตรงนี้ไม่ได้!

ทำไมล่ะครับครู... ผมนั่งใกล้ครูไม่ได้เหรอ?

เสียงของเด็กชายคนนั้นแฝงไว้ด้วยแววขบขันและกล้าท้าทาย
ครูหนุ่มนิ่งอึ้งไปชั่วครู่ ก่อนจะพยายามเก็บสีหน้าให้เรียบเฉย

เขากลับมาอีกครั้ง...
หลังจากที่หายหน้าไปนานหลายปี
และดูเหมือนว่าครั้งนี้จะไม่ได้มาดีอย่างที่คิด
"
  data-content-en="
You can't sit here!

Why not, teacher? Can’t I sit closer to you?

The boy’s voice held a teasing challenge.
The young teacher froze momentarily before regaining his composure.

He had returned...
After disappearing for years—
and it didn’t seem like he came back with good intentions.
"
  data-content-ch="
你不能坐在这里！

为什么不可以，老师……我不能靠近你坐吗？

那个男孩的话语中带着调皮和挑衅。
年轻的老师愣了一下，随即恢复了镇定。

他又回来了……
在消失多年之后，
这一次的归来似乎并不单纯。
"
  data-content-ru="
Ты не можешь сидеть здесь!

Почему, учитель?.. Разве я не могу сесть рядом?

Голос мальчика звучал с挑挑衅 и насмешкой.
Молодой учитель на мгновение замер, прежде чем вновь обрёл спокойствие.

Он вернулся…
После многих лет отсутствия,
но, похоже, не с добрыми намерениями.
"
  data-content-jp="
ここに座っちゃダメだ！

どうしてですか先生…近くに座っちゃいけないんですか？

その少年の声には、からかうような挑戦の色があった。
若い教師は一瞬言葉を失い、すぐに冷静さを取り戻した。

彼は戻ってきた…
何年も姿を消していたのに、
今回は何か企んでいるようだった。
"
  data-content-kr="
여기 앉으면 안 돼!

왜요, 선생님... 제가 선생님 가까이에 앉으면 안 되나요?

소년의 목소리는 장난기와 도발로 가득 차 있었다.
젊은 선생은 순간 멈칫했지만 곧 표정을 가다듬었다.

그가 돌아왔다...
몇 년 동안 사라졌다가,
이번에는 뭔가 꿍꿍이가 있는 것 같았다.
"
  data-content-vn="
Cậu không thể ngồi ở đây được!

Tại sao vậy thầy... Em không được ngồi gần thầy sao?

Giọng của cậu học sinh vang lên đầy tinh nghịch và thách thức.
Thầy giáo trẻ khựng lại một chút rồi lấy lại vẻ bình tĩnh.

Cậu ấy đã trở lại...
Sau nhiều năm biến mất—
và lần này có vẻ không phải trở về với ý tốt.
"
></div>
</div>

  <div class="episode">
  <div class="episode-title" onclick="toggleEpisode('ep2')">🔒 ตอนที่ 2: รอยแผลในใจ</div>
  <div class="text-content" id="ep2" style="display: none;"
  data-content-th="
เสียงฝนตกกระทบหน้าต่างห้องเรียนที่เงียบสงัด

ครูหนุ่มนั่งเหม่อมองออกไปนอกหน้าต่าง ไม่ใช่เพราะไม่มีอะไรทำ แต่เพราะบางอย่างในใจยังคงรบกวนไม่หาย

สิ่งที่เกิดขึ้นในอดีต... ยังฝังลึกอยู่ในหัวใจ
"
  data-content-en="
Rain tapped gently against the silent classroom windows.

The young teacher stared blankly outside—not from idleness, but because something deep inside still troubled him.

What had happened in the past… still echoed within his heart.
"
  data-content-jp="
静かな教室の窓に雨がぽつぽつと当たっていた。

若い教師はぼんやりと外を見つめていた。それは暇だからではなく、心の奥に何かが引っかかっていたからだ。

過去に起きた出来事は…いまだ心に深く刻まれていた。
"
  data-content-kr="
조용한 교실 창문에 빗소리가 부드럽게 울려 퍼졌다.

젊은 교사는 창밖을 멍하니 바라보았다. 할 일이 없어서가 아니라, 마음속 무언가가 여전히 그를 괴롭히고 있었기 때문이다.

과거의 일들은… 아직도 그의 가슴 속에 깊이 남아 있었다.
"
  data-content-ch="
细雨轻轻敲打着安静的教室窗户。

年轻的老师茫然地望向窗外，并不是因为无事可做，而是内心深处仍有未解的心结。

过去发生的事情……仍深深埋藏在他的心中。
"
  data-content-ru="
Мелкий дождь тихо стучал по окнам тихого класса.

Молодой учитель задумчиво смотрел в окно — не от скуки, а потому что что-то тревожило его душу.

То, что произошло в прошлом… до сих пор оставалось в его сердце.
"
  data-content-vn="
Tiếng mưa lách tách rơi trên ô cửa sổ lớp học vắng lặng.

Thầy giáo trẻ ngồi lặng lẽ nhìn ra ngoài, không phải vì không có việc gì làm mà vì có điều gì đó trong lòng vẫn chưa nguôi.

Chuyện đã xảy ra trong quá khứ… vẫn còn in hằm sâu trong tim.
"></div>
</div>
<div id="confirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4); z-index:9999;">
  <div style="background:#fff; max-width:400px; margin:15% auto; padding:30px; border-radius:12px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.2); font-family:'Mitr', sans-serif;">
    <p id="confirm-text" style="font-size:1.1rem; color:#6e3cab;" data-i18n="confirmText">ตอนนี้ต้องใช้ 2 เหรียญ<br>คุณต้องการใช้เพื่ออ่านเนื้อหาต่อหรือไม่?</p>
    <div style="margin-top:20px;">
      <button onclick="cancelUnlock()" style="margin-right:10px; padding:10px 20px; border:none; border-radius:30px; background:#ccc; color:#333; font-weight:bold;" data-i18n="cancel">ยกเลิก</button>
      <button onclick="confirmUnlock()" style="padding:10px 20px; border:none; border-radius:30px; background:#a87ce6; color:#fff; font-weight:bold;" data-i18n="confirm">ตกลง</button>
    </div>
  </div>
</div>
<div id="purchaseConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4); z-index:9999;">
  <div style="background:#fff; max-width:400px; margin:15% auto; padding:30px; border-radius:12px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.2); font-family:'Mitr', sans-serif;">
    <p id="purchase-confirm-text" style="font-size:1.1rem; color:#6e3cab;"></p>
    <div style="margin-top:20px;">
      <button onclick="cancelPurchase()" style="margin-right:10px; padding:10px 20px; border:none; border-radius:30px; background:#ccc; color:#333; font-weight:bold;" data-i18n="cancel">ยกเลิก</button>
      <button onclick="confirmPurchase()" style="padding:10px 20px; border:none; border-radius:30px; background:#a87ce6; color:#fff; font-weight:bold;" data-i18n="confirm">ตกลง</button>
    </div>
  </div>
</div>
  
<div class="comment-box">
    <h3 data-i18n="commentTitle">💬 แสดงความคิดเห็น</h3>
    <textarea rows="4" placeholder="แสดงความคิดเห็นที่นี่..." data-i18n-placeholder="commentPlaceholder"></textarea>
    <div class="emoji-bar">
      <span onclick="appendEmoji(this)">😍</span>
      <span onclick="appendEmoji(this)">😭</span>
      <span onclick="appendEmoji(this)">🔥</span>
    </div>
    <button class="submit-button" onclick="alertSubmit()" data-i18n="submitCommentButton">ส่งความคิดเห็นของคุณตรงนี้ค่ะ</button>
  </div>  
  <div class="thank-you" data-i18n="thankYou">💜 ขอบคุณที่เข้ามาอุดหนุนและติดตามนิยาย ด้วยรักจากใจ 💜</div>  
  <div class="back-container">
    <a href="/coderak/" class="back-button" data-i18n="backToPenName">← ย้อนกลับไปหน้านามปากกา โค้ดรัก</a>
  </div>  
  <div class="footer" data-i18n="footerText">
    © 2025 Arn-niyay-khan | พอร์ตนามปากกาหลากรส นักเขียนหลากแนว ✨
  </div> 

<script>
  let pendingUnlockId = null;
  let pendingPurchaseType = null; // เพิ่มตัวแปรสำหรับประเภทการซื้อ (unlockAll หรือ buyPdf)

  // ฟังก์ชันสำหรับจัดการเหรียญ
  function getCoins() {
    return parseInt(localStorage.getItem("user_coins") || "0");
  }

  function setCoins(value) {
    localStorage.setItem("user_coins", value);
    updateCoinDisplay();
  }

  function deductCoins(amount) {
    const current = getCoins();
    if (current < amount) {
      alert(`${translations[localStorage.getItem("lang") || "th"].coinNotEnough1} ${current} ${translations[localStorage.getItem("lang") || "th"].coinNotEnough2} ${amount} ${translations[localStorage.getItem("lang") || "th"].coinNotEnough3}`);
      return false;
    }
    setCoins(current - amount);
    return true;
  }

  function updateCoinDisplay() {
    const coinEl = document.getElementById("coin-count");
    if (coinEl) coinEl.textContent = getCoins();
  }

  // ฟังก์ชัน render content
  function renderEpisodeContent(block) {
    const lang = localStorage.getItem("lang") || "th";
    const content = block.getAttribute(`data-content-${lang}`) || "";
    const paragraphs = content.trim().split(/\n\s*\n|\n+/);
    block.innerHTML = `
      <div class="watermark">โค้ดรัก</div>
      ${paragraphs.map(p => `<p>${p.trim()}</p>`).join("")}
    `;
  }

  function toggleEpisode(id) {
    const el = document.getElementById(id);
    if (!el) return;

    const isUnlocked = localStorage.getItem("unlocked_" + id) === "true" || localStorage.getItem("unlocked_all") === "true";

    // ทำให้ ep1 เป็นตอนที่อ่านได้ฟรี (แก้ไขจาก 'ep1' || 'ep2' เป็นแค่ 'ep1')
    if (id === "ep1") {
      if (el.innerHTML.trim() === "") renderEpisodeContent(el);
      el.style.display = el.style.display === "none" ? "block" : "none";
      return;
    }

    // ตอนอื่นๆ (รวมถึง ep2) จะถูกล็อกหากยังไม่ปลดล็อก
    if (!isUnlocked) {
      pendingUnlockId = id;
      // อัปเดตข้อความใน confirmModal สำหรับการปลดล็อกตอนเดี่ยว
      const lang = localStorage.getItem("lang") || "th";
      const confirmText = translations[lang].confirmText;
      document.getElementById("confirm-text").innerHTML = confirmText.replace(/\n/g, "<br>");
      document.getElementById("confirmModal").style.display = "block";
      return;
    }

    if (el.innerHTML.trim() === "") renderEpisodeContent(el);
    el.style.display = el.style.display === "none" ? "block" : "none";
  }

  function cancelUnlock() {
    document.getElementById("confirmModal").style.display = "none";
    pendingUnlockId = null;
  }

  function confirmUnlock() {
    if (!pendingUnlockId) return;

    const el = document.getElementById(pendingUnlockId);
    if (!el) return;

    if (deductCoins(2)) { // หัก 2 เหรียญสำหรับการปลดล็อกตอน
      localStorage.setItem("unlocked_" + pendingUnlockId, "true");
      alert(translations[localStorage.getItem("lang") || "th"].episodeUnlockSuccess);
      renderEpisodeContent(el);
      el.style.display = "block";
    }

    document.getElementById("confirmModal").style.display = "none";
    pendingUnlockId = null;
  }

  // ฟังก์ชันใหม่สำหรับแสดง Pop-up ยืนยันการซื้อทั้งหมด / PDF
  function confirmPurchaseAll(type) {
    let cost = 0;
    let messageKey = '';
    let pdfLink = '';

    if (type === 'unlockAll') {
      cost = 4;
      messageKey = 'confirmUnlockAllText';
    } else if (type === 'buyPdf') {
      cost = 12;
      messageKey = 'confirmBuyPdfText';
      pdfLink = 'link-to-your-pdf.pdf'; // ต้องระบุลิงก์ PDF ที่นี่
    } else {
      return;
    }

    pendingPurchaseType = { type: type, cost: cost, link: pdfLink };

    const lang = localStorage.getItem("lang") || "th";
    const confirmTextEl = document.getElementById("purchase-confirm-text");
    confirmTextEl.innerHTML = (translations[lang][messageKey] || '').replace('{{cost}}', cost).replace(/\n/g, "<br>");
    
    document.getElementById("purchaseConfirmModal").style.display = "block";
  }

  // ฟังก์ชันยกเลิก Pop-up การซื้อทั้งหมด / PDF
  function cancelPurchase() {
    document.getElementById("purchaseConfirmModal").style.display = "none";
    pendingPurchaseType = null;
  }

  // ฟังก์ชันยืนยันการซื้อทั้งหมด / PDF
  function confirmPurchase() {
    if (!pendingPurchaseType) return;

    const { type, cost, link } = pendingPurchaseType;

    if (deductCoins(cost)) {
      if (type === 'unlockAll') {
        localStorage.setItem("unlocked_all", true);
        alert(translations[localStorage.getItem("lang") || "th"].unlockAllSuccess);
      } else if (type === 'buyPdf') {
        alert(translations[localStorage.getItem("lang") || "th"].buyPdfSuccess);
        if (link) {
          window.location.href = link;
        }
      }
    }

    document.getElementById("purchaseConfirmModal").style.display = "none";
    pendingPurchaseType = null;
  }


  function appendEmoji(el) {
    const textarea = document.querySelector(".comment-box textarea");
    if (textarea) {
      textarea.value += el.textContent;
      textarea.focus();
    }
  }

  // ฟังก์ชัน alertSubmit ถูกเรียกเมื่อกดปุ่มส่งความคิดเห็น
  function alertSubmit() {
    alert(translations[localStorage.getItem("lang") || "th"].submitCommentSuccess);
  }

  const translations = {
    th: {
      siteButton: "✨ Arn-niyay-khan ✨",
      unlockAll: "🔓 ปลดล็อกทุกตอนในครั้งเดียว",
      buyPdf: "📘 ซื้อ PDF + ตอนพิเศษสุดฟินมากกว่า 1 ตอน",
      unlockButton: "ปลดล็อกทุกตอน (4 เหรียญ)",
      buyPdfButton: "ซื้อ PDF ทั้งเรื่องและตอนพิเศษ (12 เหรียญ)",
      coinLabel: "💰 เหรียญของคุณ: ",
      languageLabel: "🌐 เปลี่ยนภาษา:",
      confirmText: "ตอนนี้ต้องใช้ 2 เหรียญ<br>คุณต้องการใช้เพื่ออ่านเนื้อหาต่อหรือไม่?",
      confirmUnlockAllText: "ปลดล็อกทุกตอนต้องใช้ {{cost}} เหรียญ<br>คุณต้องการปลดล็อกเลยหรือไม่?",
      confirmBuyPdfText: "ซื้อ PDF ทั้งเรื่องและตอนพิเศษต้องใช้ {{cost}} เหรียญ<br>คุณต้องการซื้อเลยหรือไม่?",
      cancel: "ยกเลิก",
      confirm: "ตกลง",
      commentTitle: "💬 แสดงความคิดเห็น",
      commentPlaceholder: "แสดงความคิดเห็นที่นี่...",
      thankYou: "💜 ขอบคุณที่เข้ามาอุดหนุนและติดตามนิยาย ด้วยรักจากใจ 💜",
      backToPenName: "← ย้อนกลับไปหน้านามปากกา โค้ดรัก",
      submitCommentButton: "ส่งความคิดเห็นของคุณตรงนี้ค่ะ", // เปลี่ยนข้อความของปุ่ม
      submitCommentSuccess: "ความคิดเห็นของคุณถูกส่งแล้ว ขอบคุณค่ะ!", // ข้อความแจ้งเตือนเมื่อส่งสำเร็จ
      novelTitle: "กับดักหัวใจของนายตัวแสบ",
      footerText: "© 2025 Arn-niyay-khan | พอร์ตนามปากกาหลากรส นักเขียนหลากแนว ✨",
      episodeUnlockSuccess: "✅ ปลดล็อกตอนสำเร็จ! ตอนนี้คุณสามารถอ่านตอนนี้ได้แล้วค่ะ",
      unlockAllSuccess: "✅ ปลดล็อกทุกตอนเรียบร้อยค่ะ!",
      buyPdfSuccess: "✅ ขอบคุณที่สนับสนุนค่ะ! ระบบจะพาไปดาวน์โหลด PDF",
      coinNotEnough1: "เหรียญไม่พอค่ะ เหลือ",
      coinNotEnough2: "เหรียญ ต้องใช้",
      coinNotEnough3: "เหรียญ"
    },
    en: {
      siteButton: "✨ Arn-niyay-khan ✨",
      unlockAll: "🔓 Unlock all episodes at once",
      buyPdf: "📘 Buy PDF + Extra Special Episodes",
      unlockButton: "Unlock all (4 coins)",
      buyPdfButton: "Buy full PDF and special Episodes (12 coins)",
      coinLabel: "💰 Your coins: ",
      languageLabel: "🌐 Language:",
      confirmText: "This episode requires 2 coins.\nWould you like to unlock it?",
      confirmUnlockAllText: "Unlocking all episodes costs {{cost}} coins.\nDo you want to proceed?",
      confirmBuyPdfText: "Buying the full PDF and special episodes costs {{cost}} coins.\nDo you want to proceed?",
      cancel: "Cancel",
      confirm: "Confirm",
      commentTitle: "💬 Leave a Comment",
      commentPlaceholder: "Write your thoughts here...",
      thankYou: "💜 Thank you for supporting this novel. With love, always 💜",
      backToPenName: "← Back to Codrak Pen Name",
      submitCommentButton: "Submit your comment here", // เปลี่ยนข้อความของปุ่ม
      submitCommentSuccess: "Your comment has been submitted. Thank you!", // ข้อความแจ้งเตือนเมื่อส่งสำเร็จ
      novelTitle: "The Mischievous Student's Heart Trap",
      footerText: "© 2025 Arn-niyay-khan | Diverse Pen Names, Diverse Authors ✨",
      episodeUnlockSuccess: "✅ Episode unlocked successfully! You can now read this episode.",
      unlockAllSuccess: "✅ All episodes unlocked!",
      buyPdfSuccess: "✅ Thank you for your support! You will be redirected to download the PDF.",
      coinNotEnough1: "Not enough coins. You have",
      coinNotEnough2: "coins. You need",
      coinNotEnough3: "coins."
    },
    ch: {
      siteButton: "✨ Arn-niyay-khan ✨",
      unlockAll: "🔓 一次解锁所有章节",
      buyPdf: "📘 购买 PDF + 特别章节",
      unlockButton: "全部解锁（4 个金币）",
      buyPdfButton: "购买完整的 PDF 和 1 集以上的特别剧集。（12 个金币）",
      coinLabel: "💰 您的金币：",
      languageLabel: "🌐 语言切换：",
      confirmText: "本章节需消耗 2 个金币。\n您是否要解锁阅读？",
      confirmUnlockAllText: "解锁所有章节需要 {{cost}} 个金币。\n您是否要继续？",
      confirmBuyPdfText: "购买完整 PDF 和特别章节需要 {{cost}} 个金币。\n您是否要继续？",
      cancel: "取消",
      confirm: "确认",
      commentTitle: "💬 发表评论",
      commentPlaceholder: "在此输入您的评论...",
      thankYou: "💜 感谢您的支持与关注，愿我们的小说温暖您心 💜",
      backToPenName: "← 返回 CodeRak 签名页面",
      submitCommentButton: "在此提交您的评论", // เปลี่ยนข้อความของปุ่ม
      submitCommentSuccess: "您的评论已提交，谢谢! ", // ข้อความแจ้งเตือนเมื่อส่งสำเร็จ
      novelTitle: "小恶魔的心陷阱",
      footerText: "© 2025 Arn-niyay-khan | 多样笔名，多样作者 ✨",
      episodeUnlockSuccess: "✅ 章节解锁成功！您现在可以阅读本章节了。",
      unlockAllSuccess: "✅ 所有章节已解锁！",
      buyPdfSuccess: "✅ 感谢您的支持！您将被重定向下载 PDF。",
      coinNotEnough1: "金币不足。您还剩",
      coinNotEnough2: "金币，需要",
      coinNotEnough3: "金币。"
    },
    ru: {
      siteButton: "✨ Arn-niyay-khan ✨",
      unlockAll: "🔓 Разблокировать все главы сразу",
      buyPdf: "📘 Купить PDF + дополнительные главы",
      unlockButton: "Разблокировать все (4 монеты)",
      buyPdfButton: "Купить все PDF-файлы и более 1 специального эпизода. (12 монет)",
      coinLabel: "💰 Ваши монеты:",
      languageLabel: "🌐 Выбрать язык:",
      confirmText: "Для этой главы нужно 2 монеты.\nРазблокировать сейчас?",
      confirmUnlockAllText: "Разблокировка всех глав стоит {{cost}} монет.\nВы хотите продолжить?",
      confirmBuyPdfText: "Покупка полного PDF и специальных глав стоит {{cost}} монет.\nВы хотите продолжить?",
      cancel: "Отмена",
      confirm: "Подтвердить",
      commentTitle: "💬 Оставить комментарий",
      commentPlaceholder: "Напишите свой комментарий здесь...",
      thankYou: "💜 Спасибо за вашу поддержку! Мы ценим каждого читателя 💜",
      backToPenName: "← Назад к псевдониму CodeRak",
      submitCommentButton: "Отправить ваш комментарий здесь", // เปลี่ยนข้อความของปุ่ม
      submitCommentSuccess: "Ваш комментарий отправлен. Спасибо!", // ข้อความแจ้งเตือนเมื่อส่งสำเร็จ
      novelTitle: "Сердечная ловушка озорного ученика",
      footerText: "© 2025 Arn-niyay-khan | Разнообразные псевдонимы, разнообразные авторы ✨",
      episodeUnlockSuccess: "✅ Глава успешно разблокирована! Теперь вы можете прочитать эту главу.",
      unlockAllSuccess: "✅ Все главы разблокированы!",
      buyPdfSuccess: "✅ Спасибо за вашу поддержку! Вы будете перенаправлены для загрузки PDF.",
      coinNotEnough1: "Недостаточно монет. У вас осталось",
      coinNotEnough2: "монет. Вам нужно",
      coinNotEnough3: "монет."
    },
    jp: {
      siteButton: "✨ Arn-niyay-khan ✨",
      coinLabel: "💰 あなたのコイン：",
      languageLabel: "🌐 言語を選択：",
      confirmText: "このエピソードには 2 コインが必要です。\n解除しますか？",
      confirmUnlockAllText: "すべてのエピソードのロックを解除するには {{cost}} コインが必要です。\n続行しますか？",
      confirmBuyPdfText: "PDF 全巻と特別エピソードの購入には {{cost}} コインが必要です。\n続行しますか？",
      cancel: "キャンセル",
      confirm: "確認",
      commentTitle: "💬 コメントを残す",
      commentPlaceholder: "ここにコメントを書いてください...",
      thankYou: "💜 ご支援ありがとうございます。愛を込めて 💜",
      backToPenName: "← コードラックのペンネームページに戻る",
      submitCommentButton: "ここにコメントを送信", // เปลี่ยนข้อความของปุ่ม
      submitCommentSuccess: "コメントが送信されました。ありがとうございます!", // ข้อความแจ้งเตือนเมื่อส่งสำเร็จ
      novelTitle: "いたずらっ子の心の罠",
      footerText: "© 2025 Arn-niyay-khan | 多様なペンネーム、多様な作家 ✨",
      episodeUnlockSuccess: "✅ エピソードのロックが解除されました！これでこのエピソードを読むことができます。",
      unlockAllSuccess: "✅ 全てのエピソードがロック解除されました！",
      buyPdfSuccess: "✅ ご支援ありがとうございます！PDFダウンロードページにリダイレクトされます。",
      coinNotEnough1: "コインが足りません。残り",
      coinNotEnough2: "コインです。必要なコインは",
      coinNotEnough3: "コインです。"
    },
    kr: {
      siteButton: "✨ Arn-niyay-khan ✨",
      coinLabel: "💰 보유 코인:",
      languageLabel: "🌐 언어 변경:",
      confirmText: "이 에피소드를 열려면 2코인이 필요합니다.\n잠금 해제하시겠습니까?",
      confirmUnlockAllText: "모든 에피소드를 잠금 해제하려면 {{cost}} 코인이 필요합니다.\n진행하시겠습니까?",
      confirmBuyPdfText: "전체 PDF 및 특별 에피소드를 구매하려면 {{cost}} 코인이 필요합니다.\n진행하시겠습니까?",
      cancel: "취소",
      confirm: "확인",
      commentTitle: "💬 댓글 남기기",
      commentPlaceholder: "여기에 댓글을 작성하세요...",
      thankYou: "💜 응원해주셔서 감사합니다. 사랑을 담아 💜",
      backToPenName: "← 코드락 필명 페이지로 돌아가기",
      submitCommentButton: "여기에 댓글을 제출하세요", // เปลี่ยนข้อความของปุ่ม
      submitCommentSuccess: "댓글이 전송되었습니다. 감사합니다!", // ข้อความแจ้งเตือนเมื่อส่งสำเร็จ
      novelTitle: "개구쟁이 학생의 함정",
      footerText: "© 2025 Arn-niyay-khan | 다양한 필명, 다양한 작가 ✨",
      episodeUnlockSuccess: "✅ 에피소드가 성공적으로 잠금 해제되었습니다! 이제 이 에피소드를 읽을 수 있습니다.",
      unlockAllSuccess: "✅ 모든 에피소드가 잠금 해제되었습니다!",
      buyPdfSuccess: "✅ 지원해주셔서 감사합니다! PDF 다운로드 페이지로 이동됩니다.",
      coinNotEnough1: "코인이 부족합니다. 현재",
      coinNotEnough2: "코인 있습니다. 필요한 코인은",
      coinNotEnough3: "코인입니다."
    },
    vn: {
      siteButton: "✨ Arn-niyay-khan ✨",
      coinLabel: "💰 Xu của bạn:",
      languageLabel: "🌐 Chọn ngôn ngữ:",
      confirmText: "Tập này cần 2 xu để mở khóa.\nBạn có muốn tiếp tục không?",
      confirmUnlockAllText: "Mở khóa tất cả các tập cần {{cost}} xu.\nBạn có muốn tiếp tục không?",
      confirmBuyPdfText: "Mua toàn bộ PDF và các tập đặc biệt cần {{cost}} xu.\nBạn có muốn tiếp tục không?",
      cancel: "Hủy",
      confirm: "Xác nhận",
      commentTitle: "💬 Để lại bình luận",
      commentPlaceholder: "Viết bình luận của bạn tại đây...",
      thankYou: "💜 Cảm ơn bạn đã ủng hộ truyện! Yêu thương từ tận đáy lòng 💜",
      backToPenName: "← Quay lại trang bút danh CodeRak",
      submitCommentButton: "Gửi bình luận của bạn tại đây", // เปลี่ยนข้อความของปุ่ม
      submitCommentSuccess: "Bình luận của bạn đã được gửi. Cảm ơn bạn!", // ข้อความแจ้งเตือนเมื่อส่งสำเร็จ
      novelTitle: "Cái bẫy trái tim của cậu học trò tinh nghịch",
      footerText: "© 2025 Arn-niyay-khan | Bút danh đa dạng, tác giả đa dạng ✨",
      episodeUnlockSuccess: "✅ Tập đã được mở khóa thành công! Bây giờ bạn có thể đọc tập này.",
      unlockAllSuccess: "✅ Tất cả các tập đã được mở khóa!",
      buyPdfSuccess: "✅ Cảm ơn bạn đã ủng hộ! Bạn sẽ được chuyển hướng để tải xuống PDF.",
      coinNotEnough1: "Không đủ xu. Bạn còn",
      coinNotEnough2: "xu. Bạn cần",
      coinNotEnough3: "xu."
    }
  };
    
  function renderSummary() {
    const summaryEl = document.getElementById("summary");
    if (!summaryEl) return;

    const lang = localStorage.getItem("lang") || "th";
    const content = summaryEl.getAttribute(`data-content-${lang}`) || "";
    const paragraphs = content.trim().split(/\n\s*\n|\n+/);
    summaryEl.innerHTML = `
      ${paragraphs.map(p => `<p>${p.trim()}</p>`).join("")}
    `;
  }

  function updateEpisodeContentByLang(lang) {
    document.querySelectorAll(".text-content").forEach(block => {
      const content = block.getAttribute(`data-content-${lang}`);
      if (content) {
        const paragraphs = content.trim().split(/\n\s*\n|\n+/);
        block.innerHTML = `
          <div class="watermark">โค้ดรัก</div>
          ${paragraphs.map(p => `<p>${p.trim()}</p>`).join("")}
        `;
      }
    });
  }
    
  function switchLang(lang) {
    const langPack = translations[lang];
    if (!langPack) return;

    // อัปเดตข้อความสำหรับองค์ประกอบที่มี data-i18n-placeholder
    document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        if (langPack[key]) el.setAttribute("placeholder", langPack[key]);
    });

    // อัปเดตข้อความสำหรับองค์ประกอบที่มี data-i18n (เช่น ปุ่มและข้อความทั่วไป)
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      if (langPack[key]) {
        // ส่วนพิเศษสำหรับ coinLabel เพื่อรักษา span ของจำนวนเหรียญ
        if (key === "coinLabel") {
          el.innerHTML = langPack[key] + `<span id="coin-count">${getCoins()}</span>` + (lang === 'th' ? ' เหรียญ' : '');
        } else {
          el.textContent = langPack[key];
        }
      }
    });

    // อัปเดตข้อความใน confirmModal (สำหรับปลดล็อกตอนเดี่ยว)
    const confirmTextEl = document.getElementById("confirm-text");
    if (confirmTextEl && langPack.confirmText) {
      confirmTextEl.innerHTML = langPack.confirmText.replace(/\n/g, "<br>");
    }

    // อัปเดตข้อความใน purchaseConfirmModal (สำหรับซื้อทั้งหมด / PDF)
    const purchaseConfirmTextEl = document.getElementById("purchase-confirm-text");
    if (purchaseConfirmTextEl && pendingPurchaseType) { // ถ้ามี Pop-up ซื้อค้างอยู่
        const type = pendingPurchaseType.type;
        const cost = pendingPurchaseType.cost;
        const messageKey = type === 'unlockAll' ? 'confirmUnlockAllText' : 'confirmBuyPdfText';
        purchaseConfirmTextEl.innerHTML = (langPack[messageKey] || '').replace('{{cost}}', cost).replace(/\n/g, "<br>");
    }


    localStorage.setItem("lang", lang);
    renderSummary(); // ต้องเรียก renderSummary() ที่นี่เพื่อให้เรื่องย่อเปลี่ยนภาษา
    updateEpisodeContentByLang(lang);
    updateCoinDisplay(); // เรียกให้แสดงผลเหรียญให้ถูกต้องเมื่อเปลี่ยนภาษา
  }

  // เมื่อ DOM โหลดเสร็จ
  document.addEventListener("DOMContentLoaded", function () {
    // ตรวจสอบและกำหนดเหรียญเริ่มต้นถ้ายังไม่มี
    if (!localStorage.getItem("user_coins")) {
      setCoins(100); // กำหนดเหรียญเริ่มต้น 100 เหรียญ
    }

    const savedLang = localStorage.getItem("lang") || "th";
    switchLang(savedLang); // Apply the saved language and render all content on load

    // ไม่ต้องเรียก renderSummary() หรือ updateEpisodeContentByLang() ซ้ำที่นี่
    // เพราะ switchLang(savedLang) จะจัดการให้แล้ว
  });
</script>

</body>
</html>
